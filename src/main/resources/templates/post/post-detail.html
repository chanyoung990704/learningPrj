<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <div th:replace="~{/common/header :: head-common}"></div>
  <link rel="stylesheet" th:href="@{/css/components/post-common.css}">
  <link rel="stylesheet" th:href="@{/css/components/post-detail.css}">
  <link rel="stylesheet" th:href="@{/css/components/comments.css}">
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>
<div th:replace="~{/common/header :: top-banner}"></div>
<main class="post-detail-page">
  <!-- ê²Œì‹œê¸€ í—¤ë” -->
  <header class="post-header">
    <h1 class="post-title" th:text="${post.title} ?: #{post.title.default}">ê²Œì‹œê¸€ ì œëª©</h1>
    <div class="post-meta">
      <span class="post-category" th:text="${post.category?.name} ?: #{post.category.unclassified}">ì¹´í…Œê³ ë¦¬</span>
      <span class="post-meta-item">
        <span class="material-icons" style="font-size: 1.1em; margin-right: 0.25rem;" th:text="#{post.author}">person</span>
        <span th:text="${post.author} ?: #{post.author.unknown}">ì‘ì„±ì</span>
      </span>
      <span class="post-meta-item">
        <span class="material-icons" style="font-size: 1.1em; margin-right: 0.25rem;" th:text="#{post.time}">schedule</span>
        <span th:text="${#temporals.format(post.time, 'yyyy.MM.dd HH:mm')}">2023.01.01 12:00</span>
      </span>
      <span class="post-meta-item">
        <span class="material-icons" style="font-size: 1.1em; margin-right: 0.25rem;" th:text="#{post.views}">visibility</span>
        <span th:text="|${post.viewCount} #{post.views}|">0 ì¡°íšŒìˆ˜</span>
      </span>
    </div>
  </header>

  <!-- ê²Œì‹œê¸€ ë³¸ë¬¸ ìˆ˜ì • -->
  <article class="post-content">
    <div th:utext="${post.content}"></div>

    <!-- ì²¨ë¶€íŒŒì¼ ì¤‘ ì´ë¯¸ì§€ë“¤ì„ ë³¸ë¬¸ì— ìë™ ì‚½ì… -->
    <div th:each="image : ${post.imageAttachments}" th:if="${not #lists.isEmpty(post.imageAttachments)}">
      <img th:src="@{/posts/uploads/images/{filename}(filename=${image.storedName})}"
           th:alt="${image.originalName}"
           data-lightbox="post-images"
           loading="lazy">
    </div>
  </article>


  <!-- âœ¨ ì¶”ê°€: ì²¨ë¶€íŒŒì¼ ì„¹ì…˜ -->
  <!-- ì²¨ë¶€íŒŒì¼ ì„¹ì…˜ -->
  <section class="attachments-section" th:if="${not #lists.isEmpty(post.imageAttachments) or not #lists.isEmpty(post.otherAttachments)}">
    <h4 class="attachments-title">ğŸ“ <span th:text="#{post.content.attachments}">ì²¨ë¶€íŒŒì¼</span></h4>

    <ul class="file-list">
      <!-- ì´ë¯¸ì§€ ì²¨ë¶€íŒŒì¼ -->
      <th:block th:if="${#authorization.expression('isAuthenticated()')}">
        <li th:each="image : ${post.imageAttachments}" th:if="${not #lists.isEmpty(post.imageAttachments)}">
          <a th:href="@{/posts/uploads/files/{id}(id=${image.id})}"
             class="file-download-link"
             download
             th:download="${image.originalName}">
            <div class="file-icon image-file">ğŸ–¼ï¸</div>
            <div class="file-info">
              <div class="file-name" th:text="${image.originalName}">image.jpg</div>
              <div class="file-size" th:text="${image.fileSize != null ? #numbers.formatDecimal(image.fileSize / 1024.0 / 1024.0, 1, 1) + ' MB' : 'Unknown size'}">2.1 MB</div>
            </div>
          </a>
        </li>

        <!-- ê¸°íƒ€ ì²¨ë¶€íŒŒì¼ -->
        <li th:each="file : ${post.otherAttachments}" th:if="${not #lists.isEmpty(post.otherAttachments)}">
          <a th:href="@{/posts/uploads/files/{id}(id=${file.id})}"
             class="file-download-link"
             download
             th:download="${file.originalName}">
            <div class="file-icon document-file">
              <!-- íŒŒì¼ í™•ì¥ìì— ë”°ë¥¸ ì•„ì´ì½˜ í‘œì‹œ -->
              <span th:if="${file.originalName != null and #strings.contains(file.originalName, '.')}"
              >
              </span>
            </div>
            <div class="file-info">
              <div class="file-name" th:text="${file.originalName}">file.txt</div>
              <div class="file-size" th:text="${file.fileSize != null ? #numbers.formatDecimal(file.fileSize / 1024.0 / 1024.0, 1, 1) + ' MB' : 'Unknown size'}">1.2 MB</div>
            </div>
          </a>
        </li>
      </th:block>
      <th:block th:unless="${#authorization.expression('isAuthenticated()')}">
        <li>
          <span th:text="#{post.attachment.loginRequired}">ì²¨ë¶€íŒŒì¼ ë‹¤ìš´ë¡œë“œëŠ” ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</span>
        </li>
      </th:block>
    </ul>
  </section>



  <!-- ì¢‹ì•„ìš” ì„¹ì…˜ -->
  <div class="like-section">
    <button id="likeButton" type="button" class="like-button">
      <span class="like-icon">â¤ï¸</span>
      <span id="likeCount" th:text="${post.likeCount}">0</span>
    </button>
  </div>

  <!-- ê²Œì‹œê¸€ í•˜ë‹¨ ì•¡ì…˜ ë²„íŠ¼ -->
  <div class="post-actions">
    <a th:href="@{/posts/{categoryName}(categoryName=${post.category.name})}" class="btn btn-secondary">
      <span th:text="#{button.back}">ëª©ë¡ìœ¼ë¡œ</span>
    </a>
    <div class="author-actions" th:if="${#authorization.expression('isAuthenticated()') && post.email == #authentication.name}">
      <a th:href="@{/posts/{id}/edit(id=${post.id})}" class="btn btn-edit">
        <span th:text="#{button.edit}">ìˆ˜ì •</span>
      </a>
      <form th:action="@{/posts/{id}(id=${post.id})}" method="post" style="display:inline;">
        <input type="hidden" name="_method" value="DELETE"/>
        <input type="hidden" name="categoryName" th:value="${post.category.name}"/>
        <button type="submit" class="btn btn-delete" th:onclick="'return confirm(\'' + #{confirm.delete.post} + '\');'">
          <span th:text="#{button.delete}">ì‚­ì œ</span>
        </button>
      </form>
    </div>
  </div>
  <!-- ======================= ëŒ“ê¸€ ì„¹ì…˜ ======================= -->
  <section class="comments-section" id="comments">
    <h3>
      <span th:text="#{post.comments}">ëŒ“ê¸€</span>
      <span class="comments-count" th:if="${commentCount > 0}" th:text="${commentCount}">0</span>
    </h3>

    <!-- ëŒ“ê¸€ ëª©ë¡ -->
    <ul class="comment-list">
      <!-- ìµœìƒìœ„ ëŒ“ê¸€ ìˆœíšŒ -->
      <li th:each="comment : ${post.comments.content}" class="comment-item" th:id="'comment-' + ${comment.id}">
        <div class="comment-header">
          <div class="comment-user">
            <span class="comment-author" th:text="${comment.userName} ?: #{comment.author.unknown}">ì‘ì„±ì</span>
            <span class="comment-time" th:text="${#temporals.format(comment.createdAt, 'yyyy.MM.dd HH:mm')}">2023.01.01 12:00</span>
          </div>
          <div class="comment-actions">
            <!-- âœ¨ ìˆ˜ì •: ë‹µê¸€ ë²„íŠ¼ì„ ë¡œê·¸ì¸ ìƒíƒœì—ì„œë§Œ í‘œì‹œ -->
            <button type="button" class="btn-reply"
                    th:if="${#authorization.expression('isAuthenticated()')}"
                    th:attr="data-comment-id=${comment.id},data-comment-author=${comment.userName}"
                    th:text="#{button.reply}">ë‹µê¸€</button>
            <div class="comment-owner-actions"
                 th:if="${#authorization.expression('isAuthenticated()') and (comment.userEmail == #authentication.principal.email)}">
              <button type="button" class="btn-edit-comment"
                      th:attr="data-comment-id=${comment.id}" th:text="#{button.edit}">ìˆ˜ì •</button>
              <form th:action="@{/posts/{postId}/comments/{commentId}(postId=${post.id},commentId=${comment.id})}"
                    method="post" style="display:inline;">
                <input type="hidden" name="_method" value="DELETE"/>
                <button type="submit" class="btn-delete-comment" th:text="#{button.delete}">ì‚­ì œ</button>
              </form>
            </div>
          </div>
        </div>
        <div class="comment-content" th:id="'comment-content-' + ${comment.id}" th:text="${comment.content}">ëŒ“ê¸€ ë‚´ìš©ì…ë‹ˆë‹¤.</div>

        <!-- ëŒ“ê¸€ ìˆ˜ì • í¼ -->
        <form th:action="@{/posts/{postId}/comments/{commentId}(postId=${post.id},commentId=${comment.id})}"
              method="post" th:id="'comment-edit-form-' + ${comment.id}" class="edit-form" style="display:none;">
          <input type="hidden" name="_method" value="put"/>
          <textarea class="edit-textarea" name="content" required></textarea>
          <div class="edit-actions">
            <button type="button" class="btn-cancel-edit" th:attr="data-comment-id=${comment.id}" th:text="#{button.cancel}">ì·¨ì†Œ</button>
            <button type="submit" class="btn-save-edit" th:text="#{button.save}">ì €ì¥</button>
          </div>
        </form>

        <!-- âœ¨ ìˆ˜ì •: ë‹µê¸€ í¼ì„ ë¡œê·¸ì¸ ìƒíƒœì—ì„œë§Œ í‘œì‹œ -->
        <div class="reply-form" th:if="${#authorization.expression('isAuthenticated()')}" th:id="'reply-form-' + ${comment.id}" style="display: none;">
          <form th:action="@{/posts/{postId}/comments/{parentId}/replies(postId=${post.id},parentId=${comment.id})}"
                method="post" th:object="${replyAddRequest}">
            <input type="hidden" name="parentId" th:value="${comment.id}">
            <textarea name="content" th:field="*{content}" th:placeholder="#{reply.placeholder}"></textarea>
            <div class="reply-actions">
              <button type="button" class="btn-cancel-reply" th:attr="data-comment-id=${comment.id}" th:text="#{button.cancel}">ì·¨ì†Œ</button>
              <button type="submit" class="btn-submit-reply" th:text="#{button.reply}">ë‹µê¸€</button>
            </div>
          </form>
        </div>

        <!-- âœ¨ ìˆ˜ì •: ëŒ€ëŒ“ê¸€ ëª©ë¡ì„ ë Œë”ë§í•˜ê¸° ìœ„í•´ ì¬ê·€ í”„ë˜ê·¸ë¨¼íŠ¸ í˜¸ì¶œ -->
        <div class="replies-container" th:if="${not #lists.isEmpty(comment.replies)}">
          <ul class="replies-list">
            <li th:replace="~{this :: renderReplies(${comment.replies}, ${post}, ${replyAddRequest})}"></li>
          </ul>
        </div>
      </li>
      <li class="no-comments" th:if="${#lists.isEmpty(post.comments.content)}">
        <p th:text="#{comment.empty}">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
      </li>
    </ul>
    <!-- ëŒ“ê¸€ í˜ì´ì§€ë„¤ì´ì…˜ -->
    <div class="comment-pagination" th:if="${post.comments.totalPages > 1}">
      <ul class="pagination">
        <li class="page-item" th:classappend="${post.comments.first} ? 'disabled'">
          <a class="page-link"
             th:href="@{/posts/{categoryName}/{id}(categoryName=${post.category.name}, id=${post.id}, commentPage=${post.comments.number - 1})}"
             th:text="#{pagination.prev}" aria-label="Previous">ì´ì „</a>
        </li>
        <li class="page-item"
            th:each="pageNumber : ${#numbers.sequence(0, post.comments.totalPages - 1)}"
            th:classappend="${pageNumber == post.comments.number} ? 'active'">
          <a class="page-link"
             th:href="@{/posts/{categoryName}/{id}(categoryName=${post.category.name}, id=${post.id}, commentPage=${pageNumber})}"
             th:text="${pageNumber + 1}">1</a>
        </li>
        <li class="page-item" th:classappend="${post.comments.last} ? 'disabled'">
          <a class="page-link"
             th:href="@{/posts/{categoryName}/{id}(categoryName=${post.category.name}, id=${post.id}, commentPage=${post.comments.number + 1})}"
             th:text="#{pagination.next}" aria-label="Next">ë‹¤ìŒ</a>
        </li>
      </ul>
    </div>

    <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
    <div class="comment-form" th:if="${#authorization.expression('isAuthenticated()')}">
      <h4 th:text="#{comment.write}">ëŒ“ê¸€ ì‘ì„±</h4>
      <form th:action="@{/posts/{id}/comments(id=${post.id})}" method="post" th:object="${commentAddRequest}">
        <input type="hidden" name="parentId" value="">
        <textarea name="content" th:placeholder="#{comment.placeholder}" th:field="*{content}"></textarea>
        <p class="error-message" th:if="${#fields.hasErrors('content')}" th:errors="*{content}"></p>
        <button type="submit" class="comment-submit-btn" th:text="#{button.write}">ë“±ë¡</button>
      </form>
    </div>

    <!-- ë¡œê·¸ì¸ ì•ˆë‚´ -->
    <div class="login-prompt" th:if="${!#authorization.expression('isAuthenticated()')}">
      <p>
        <span th:text="#{comment.login.prefix}">ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ </span>
        <a th:href="@{/login}" th:text="#{button.login}">ë¡œê·¸ì¸</a>
        <span th:text="#{comment.login.suffix}">ì´ í•„ìš”í•©ë‹ˆë‹¤.</span>
      </p>
    </div>
  </section>

  <!-- âœ¨âœ¨âœ¨ ì¶”ê°€: ëŒ€ëŒ“ê¸€ ë Œë”ë§ì„ ìœ„í•œ ì¬ê·€ í”„ë˜ê·¸ë¨¼íŠ¸ âœ¨âœ¨âœ¨ -->
  <div th:fragment="renderReplies(replies, post, replyAddRequest)" th:remove="tag">
    <div th:each="reply : ${replies}" class="comment-item reply-comment" th:id="'comment-' + ${reply.id}">
      <div class="comment-header">
        <div class="comment-user">
          <span class="comment-author" th:text="${reply.userName} ?: #{comment.author.unknown}">ì‘ì„±ì</span>
          <span class="comment-time" th:text="${#temporals.format(reply.createdAt, 'yyyy.MM.dd HH:mm')}">2023.01.01 12:00</span>
        </div>
        <div class="comment-actions">
          <!-- âœ¨ ìˆ˜ì •: ë‹µê¸€ ë²„íŠ¼ì„ ë¡œê·¸ì¸ ìƒíƒœì—ì„œë§Œ í‘œì‹œ -->
          <button type="button" class="btn-reply"
                  th:if="${#authorization.expression('isAuthenticated()')}"
                  th:attr="data-comment-id=${reply.id},data-comment-author=${reply.userName}"
                  th:text="#{button.reply}">ë‹µê¸€</button>
          <div class="comment-owner-actions" th:if="${#authorization.expression('isAuthenticated()') and (reply.userEmail == #authentication.principal.email)}">
            <button type="button" class="btn-edit-comment" th:attr="data-comment-id=${reply.id}" th:text="#{button.edit}">ìˆ˜ì •</button>
            <form th:action="@{/posts/{postId}/comments/{commentId}(postId=${post.id},commentId=${reply.id})}" method="post" style="display:inline;">
              <input type="hidden" name="_method" value="DELETE"/>
              <button type="submit" class="btn-delete-comment" th:text="#{button.delete}">ì‚­ì œ</button>
            </form>
          </div>
        </div>
      </div>
      <div class="comment-content" th:id="'comment-content-' + ${reply.id}" th:text="${reply.content}"></div>
      <form th:action="@{/posts/{postId}/comments/{commentId}(postId=${post.id},commentId=${reply.id})}" method="post" th:id="'comment-edit-form-' + ${reply.id}" class="edit-form" style="display:none;">
        <input type="hidden" name="_method" value="put"/>
        <textarea class="edit-textarea" name="content" required></textarea>
        <div class="edit-actions">
          <button type="button" class="btn-cancel-edit" th:attr="data-comment-id=${reply.id}" th:text="#{button.cancel}">ì·¨ì†Œ</button>
          <button type="submit" class="btn-save-edit" th:text="#{button.save}">ì €ì¥</button>
        </div>
      </form>

      <!-- âœ¨ ìˆ˜ì •: ë‹µê¸€ í¼ì„ ë¡œê·¸ì¸ ìƒíƒœì—ì„œë§Œ í‘œì‹œ -->
      <div class="reply-form" th:if="${#authorization.expression('isAuthenticated()')}" th:id="'reply-form-' + ${reply.id}" style="display: none;">
        <form th:action="@{/posts/{postId}/comments/{parentId}/replies(postId=${post.id},parentId=${reply.id})}" method="post" th:object="${replyAddRequest}">
          <input type="hidden" name="parentId" th:value="${reply.id}">
          <textarea name="content" th:field="*{content}" th:placeholder="#{reply.placeholder}"></textarea>
          <div class="reply-actions">
            <button type="button" class="btn-cancel-reply" th:attr="data-comment-id=${reply.id}" th:text="#{button.cancel}">ì·¨ì†Œ</button>
            <button type="submit" class="btn-submit-reply" th:text="#{button.reply}">ë‹µê¸€</button>
          </div>
        </form>
      </div>

      <!-- í”„ë˜ê·¸ë¨¼íŠ¸ ë‚´ë¶€ì—ì„œ ìê¸° ìì‹ ì„ ë‹¤ì‹œ í˜¸ì¶œ -->
      <div class="replies-container" th:if="${not #lists.isEmpty(reply.replies)}">
        <ul class="replies-list">
          <li th:replace="~{this :: renderReplies(${reply.replies}, ${post}, ${replyAddRequest})}"></li>
        </ul>
      </div>
    </div>
  </div>

</main>
<footer th:replace="~{/common/footer :: footer}"></footer>

<!-- JavaScript -->
<script src="/js/comments.js"></script>
<script th:inline="javascript">
  document.addEventListener('DOMContentLoaded', function() {
    const likeButton = document.getElementById('likeButton');
    const likeCount = document.getElementById('likeCount');
    const csrfToken = /*[[${_csrf.token}]]*/ '';
    const csrfHeader = /*[[${_csrf.headerName}]]*/ 'X-CSRF-TOKEN';
    const postId = /*[[${post.id}]]*/ '0';

    if (likeButton) {
      likeButton.addEventListener('click', async function() {
        try {
          const response = await fetch(`/posts/${postId}/like`, {
            method: 'POST',
            headers: {
              [csrfHeader]: csrfToken,
              'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
          });
          if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
          }
          const result = await response.json();
          if (result.success) {
            likeButton.classList.toggle('liked', result.isLiked);
            likeCount.textContent = result.likeCount;
            const icon = likeButton.querySelector('.like-icon');
            icon.style.animation = 'none';
            void icon.offsetWidth;
            icon.style.animation = 'heartBeat 0.6s';
          } else {
            alert(/*[[#{error.like.failed}]]*/ 'ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }
        } catch (error) {
          console.error('Error:', error);
          alert(/*[[#{error.occurred}]]*/ 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
      });
    }
  });
</script>
</body>
</html>
