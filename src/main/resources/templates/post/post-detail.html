<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <div th:replace="~{/common/header :: head-common}"></div>
  <link rel="stylesheet" th:href="@{/css/components/post-common.css}">
  <link rel="stylesheet" th:href="@{/css/components/post-detail.css}">
  <link rel="stylesheet" th:href="@{/css/components/comments.css}">
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>
<div th:replace="~{/common/header :: top-banner}"></div>
<main class="post-detail-page">
  <!-- 게시글 헤더 -->
  <header class="post-header">
    <h1 class="post-title" th:text="${post.title} ?: #{post.title.default}">게시글 제목</h1>
    <div class="post-meta">
      <span class="post-category" th:text="${post.category?.name} ?: #{post.category.unclassified}">카테고리</span>
      <span class="post-meta-item">
        <span class="material-icons" style="font-size: 1.1em; margin-right: 0.25rem;" th:text="#{post.author}">person</span>
        <span th:text="${post.author} ?: #{post.author.unknown}">작성자</span>
      </span>
      <span class="post-meta-item">
        <span class="material-icons" style="font-size: 1.1em; margin-right: 0.25rem;" th:text="#{post.time}">schedule</span>
        <span th:text="${#temporals.format(post.time, 'yyyy.MM.dd HH:mm')}">2023.01.01 12:00</span>
      </span>
      <span class="post-meta-item">
        <span class="material-icons" style="font-size: 1.1em; margin-right: 0.25rem;" th:text="#{post.views}">visibility</span>
        <span th:text="|${post.viewCount} #{post.views}|">0 조회수</span>
      </span>
    </div>
  </header>

  <!-- 게시글 본문 수정 -->
  <article class="post-content">
    <div th:utext="${post.content}"></div>

    <!-- 첨부파일 중 이미지들을 본문에 자동 삽입 -->
    <div th:each="image : ${post.imageAttachments}" th:if="${not #lists.isEmpty(post.imageAttachments)}">
      <img th:src="@{/posts/uploads/images/{filename}(filename=${image.storedName})}"
           th:alt="${image.originalName}"
           data-lightbox="post-images"
           loading="lazy">
    </div>
  </article>


  <!-- ✨ 추가: 첨부파일 섹션 -->
  <!-- 첨부파일 섹션 -->
  <section class="attachments-section" th:if="${not #lists.isEmpty(post.imageAttachments) or not #lists.isEmpty(post.otherAttachments)}">
    <h4 class="attachments-title">📎 <span th:text="#{post.content.attachments}">첨부파일</span></h4>

    <ul class="file-list">
      <!-- 이미지 첨부파일 -->
      <th:block th:if="${#authorization.expression('isAuthenticated()')}">
        <li th:each="image : ${post.imageAttachments}" th:if="${not #lists.isEmpty(post.imageAttachments)}">
          <a th:href="@{/posts/uploads/files/{id}(id=${image.id})}"
             class="file-download-link"
             download
             th:download="${image.originalName}">
            <div class="file-icon image-file">🖼️</div>
            <div class="file-info">
              <div class="file-name" th:text="${image.originalName}">image.jpg</div>
              <div class="file-size" th:text="${image.fileSize != null ? #numbers.formatDecimal(image.fileSize / 1024.0 / 1024.0, 1, 1) + ' MB' : 'Unknown size'}">2.1 MB</div>
            </div>
          </a>
        </li>

        <!-- 기타 첨부파일 -->
        <li th:each="file : ${post.otherAttachments}" th:if="${not #lists.isEmpty(post.otherAttachments)}">
          <a th:href="@{/posts/uploads/files/{id}(id=${file.id})}"
             class="file-download-link"
             download
             th:download="${file.originalName}">
            <div class="file-icon document-file">
              <!-- 파일 확장자에 따른 아이콘 표시 -->
              <span th:if="${file.originalName != null and #strings.contains(file.originalName, '.')}"
              >
              </span>
            </div>
            <div class="file-info">
              <div class="file-name" th:text="${file.originalName}">file.txt</div>
              <div class="file-size" th:text="${file.fileSize != null ? #numbers.formatDecimal(file.fileSize / 1024.0 / 1024.0, 1, 1) + ' MB' : 'Unknown size'}">1.2 MB</div>
            </div>
          </a>
        </li>
      </th:block>
      <th:block th:unless="${#authorization.expression('isAuthenticated()')}">
        <li>
          <span th:text="#{post.attachment.loginRequired}">첨부파일 다운로드는 로그인 후 이용 가능합니다.</span>
        </li>
      </th:block>
    </ul>
  </section>



  <!-- 좋아요 섹션 -->
  <div class="like-section">
    <button id="likeButton" type="button" class="like-button">
      <span class="like-icon">❤️</span>
      <span id="likeCount" th:text="${post.likeCount}">0</span>
    </button>
  </div>

  <!-- 게시글 하단 액션 버튼 -->
  <div class="post-actions">
    <a th:href="@{/posts/{categoryName}(categoryName=${post.category.name})}" class="btn btn-secondary">
      <span th:text="#{button.back}">목록으로</span>
    </a>
    <div class="author-actions" th:if="${#authorization.expression('isAuthenticated()') && post.email == #authentication.name}">
      <a th:href="@{/posts/{id}/edit(id=${post.id})}" class="btn btn-edit">
        <span th:text="#{button.edit}">수정</span>
      </a>
      <form th:action="@{/posts/{id}(id=${post.id})}" method="post" style="display:inline;">
        <input type="hidden" name="_method" value="DELETE"/>
        <input type="hidden" name="categoryName" th:value="${post.category.name}"/>
        <button type="submit" class="btn btn-delete" th:onclick="'return confirm(\'' + #{confirm.delete.post} + '\');'">
          <span th:text="#{button.delete}">삭제</span>
        </button>
      </form>
    </div>
  </div>
  <!-- ======================= 댓글 섹션 ======================= -->
  <section class="comments-section" id="comments">
    <h3>
      <span th:text="#{post.comments}">댓글</span>
      <span class="comments-count" th:if="${commentCount > 0}" th:text="${commentCount}">0</span>
    </h3>

    <!-- 댓글 목록 -->
    <ul class="comment-list">
      <!-- 최상위 댓글 순회 -->
      <li th:each="comment : ${post.comments.content}" class="comment-item" th:id="'comment-' + ${comment.id}">
        <div class="comment-header">
          <div class="comment-user">
            <span class="comment-author" th:text="${comment.userName} ?: #{comment.author.unknown}">작성자</span>
            <span class="comment-time" th:text="${#temporals.format(comment.createdAt, 'yyyy.MM.dd HH:mm')}">2023.01.01 12:00</span>
          </div>
          <div class="comment-actions">
            <!-- ✨ 수정: 답글 버튼을 로그인 상태에서만 표시 -->
            <button type="button" class="btn-reply"
                    th:if="${#authorization.expression('isAuthenticated()')}"
                    th:attr="data-comment-id=${comment.id},data-comment-author=${comment.userName}"
                    th:text="#{button.reply}">답글</button>
            <div class="comment-owner-actions"
                 th:if="${#authorization.expression('isAuthenticated()') and (comment.userEmail == #authentication.principal.email)}">
              <button type="button" class="btn-edit-comment"
                      th:attr="data-comment-id=${comment.id}" th:text="#{button.edit}">수정</button>
              <form th:action="@{/posts/{postId}/comments/{commentId}(postId=${post.id},commentId=${comment.id})}"
                    method="post" style="display:inline;">
                <input type="hidden" name="_method" value="DELETE"/>
                <button type="submit" class="btn-delete-comment" th:text="#{button.delete}">삭제</button>
              </form>
            </div>
          </div>
        </div>
        <div class="comment-content" th:id="'comment-content-' + ${comment.id}" th:text="${comment.content}">댓글 내용입니다.</div>

        <!-- 댓글 수정 폼 -->
        <form th:action="@{/posts/{postId}/comments/{commentId}(postId=${post.id},commentId=${comment.id})}"
              method="post" th:id="'comment-edit-form-' + ${comment.id}" class="edit-form" style="display:none;">
          <input type="hidden" name="_method" value="put"/>
          <textarea class="edit-textarea" name="content" required></textarea>
          <div class="edit-actions">
            <button type="button" class="btn-cancel-edit" th:attr="data-comment-id=${comment.id}" th:text="#{button.cancel}">취소</button>
            <button type="submit" class="btn-save-edit" th:text="#{button.save}">저장</button>
          </div>
        </form>

        <!-- ✨ 수정: 답글 폼을 로그인 상태에서만 표시 -->
        <div class="reply-form" th:if="${#authorization.expression('isAuthenticated()')}" th:id="'reply-form-' + ${comment.id}" style="display: none;">
          <form th:action="@{/posts/{postId}/comments/{parentId}/replies(postId=${post.id},parentId=${comment.id})}"
                method="post" th:object="${replyAddRequest}">
            <input type="hidden" name="parentId" th:value="${comment.id}">
            <textarea name="content" th:field="*{content}" th:placeholder="#{reply.placeholder}"></textarea>
            <div class="reply-actions">
              <button type="button" class="btn-cancel-reply" th:attr="data-comment-id=${comment.id}" th:text="#{button.cancel}">취소</button>
              <button type="submit" class="btn-submit-reply" th:text="#{button.reply}">답글</button>
            </div>
          </form>
        </div>

        <!-- ✨ 수정: 대댓글 목록을 렌더링하기 위해 재귀 프래그먼트 호출 -->
        <div class="replies-container" th:if="${not #lists.isEmpty(comment.replies)}">
          <ul class="replies-list">
            <li th:replace="~{this :: renderReplies(${comment.replies}, ${post}, ${replyAddRequest})}"></li>
          </ul>
        </div>
      </li>
      <li class="no-comments" th:if="${#lists.isEmpty(post.comments.content)}">
        <p th:text="#{comment.empty}">아직 댓글이 없습니다. 첫 댓글을 작성해보세요!</p>
      </li>
    </ul>
    <!-- 댓글 페이지네이션 -->
    <div class="comment-pagination" th:if="${post.comments.totalPages > 1}">
      <ul class="pagination">
        <li class="page-item" th:classappend="${post.comments.first} ? 'disabled'">
          <a class="page-link"
             th:href="@{/posts/{categoryName}/{id}(categoryName=${post.category.name}, id=${post.id}, commentPage=${post.comments.number - 1})}"
             th:text="#{pagination.prev}" aria-label="Previous">이전</a>
        </li>
        <li class="page-item"
            th:each="pageNumber : ${#numbers.sequence(0, post.comments.totalPages - 1)}"
            th:classappend="${pageNumber == post.comments.number} ? 'active'">
          <a class="page-link"
             th:href="@{/posts/{categoryName}/{id}(categoryName=${post.category.name}, id=${post.id}, commentPage=${pageNumber})}"
             th:text="${pageNumber + 1}">1</a>
        </li>
        <li class="page-item" th:classappend="${post.comments.last} ? 'disabled'">
          <a class="page-link"
             th:href="@{/posts/{categoryName}/{id}(categoryName=${post.category.name}, id=${post.id}, commentPage=${post.comments.number + 1})}"
             th:text="#{pagination.next}" aria-label="Next">다음</a>
        </li>
      </ul>
    </div>

    <!-- 댓글 작성 폼 -->
    <div class="comment-form" th:if="${#authorization.expression('isAuthenticated()')}">
      <h4 th:text="#{comment.write}">댓글 작성</h4>
      <form th:action="@{/posts/{id}/comments(id=${post.id})}" method="post" th:object="${commentAddRequest}">
        <input type="hidden" name="parentId" value="">
        <textarea name="content" th:placeholder="#{comment.placeholder}" th:field="*{content}"></textarea>
        <p class="error-message" th:if="${#fields.hasErrors('content')}" th:errors="*{content}"></p>
        <button type="submit" class="comment-submit-btn" th:text="#{button.write}">등록</button>
      </form>
    </div>

    <!-- 로그인 안내 -->
    <div class="login-prompt" th:if="${!#authorization.expression('isAuthenticated()')}">
      <p>
        <span th:text="#{comment.login.prefix}">댓글을 작성하려면 </span>
        <a th:href="@{/login}" th:text="#{button.login}">로그인</a>
        <span th:text="#{comment.login.suffix}">이 필요합니다.</span>
      </p>
    </div>
  </section>

  <!-- ✨✨✨ 추가: 대댓글 렌더링을 위한 재귀 프래그먼트 ✨✨✨ -->
  <div th:fragment="renderReplies(replies, post, replyAddRequest)" th:remove="tag">
    <div th:each="reply : ${replies}" class="comment-item reply-comment" th:id="'comment-' + ${reply.id}">
      <div class="comment-header">
        <div class="comment-user">
          <span class="comment-author" th:text="${reply.userName} ?: #{comment.author.unknown}">작성자</span>
          <span class="comment-time" th:text="${#temporals.format(reply.createdAt, 'yyyy.MM.dd HH:mm')}">2023.01.01 12:00</span>
        </div>
        <div class="comment-actions">
          <!-- ✨ 수정: 답글 버튼을 로그인 상태에서만 표시 -->
          <button type="button" class="btn-reply"
                  th:if="${#authorization.expression('isAuthenticated()')}"
                  th:attr="data-comment-id=${reply.id},data-comment-author=${reply.userName}"
                  th:text="#{button.reply}">답글</button>
          <div class="comment-owner-actions" th:if="${#authorization.expression('isAuthenticated()') and (reply.userEmail == #authentication.principal.email)}">
            <button type="button" class="btn-edit-comment" th:attr="data-comment-id=${reply.id}" th:text="#{button.edit}">수정</button>
            <form th:action="@{/posts/{postId}/comments/{commentId}(postId=${post.id},commentId=${reply.id})}" method="post" style="display:inline;">
              <input type="hidden" name="_method" value="DELETE"/>
              <button type="submit" class="btn-delete-comment" th:text="#{button.delete}">삭제</button>
            </form>
          </div>
        </div>
      </div>
      <div class="comment-content" th:id="'comment-content-' + ${reply.id}" th:text="${reply.content}"></div>
      <form th:action="@{/posts/{postId}/comments/{commentId}(postId=${post.id},commentId=${reply.id})}" method="post" th:id="'comment-edit-form-' + ${reply.id}" class="edit-form" style="display:none;">
        <input type="hidden" name="_method" value="put"/>
        <textarea class="edit-textarea" name="content" required></textarea>
        <div class="edit-actions">
          <button type="button" class="btn-cancel-edit" th:attr="data-comment-id=${reply.id}" th:text="#{button.cancel}">취소</button>
          <button type="submit" class="btn-save-edit" th:text="#{button.save}">저장</button>
        </div>
      </form>

      <!-- ✨ 수정: 답글 폼을 로그인 상태에서만 표시 -->
      <div class="reply-form" th:if="${#authorization.expression('isAuthenticated()')}" th:id="'reply-form-' + ${reply.id}" style="display: none;">
        <form th:action="@{/posts/{postId}/comments/{parentId}/replies(postId=${post.id},parentId=${reply.id})}" method="post" th:object="${replyAddRequest}">
          <input type="hidden" name="parentId" th:value="${reply.id}">
          <textarea name="content" th:field="*{content}" th:placeholder="#{reply.placeholder}"></textarea>
          <div class="reply-actions">
            <button type="button" class="btn-cancel-reply" th:attr="data-comment-id=${reply.id}" th:text="#{button.cancel}">취소</button>
            <button type="submit" class="btn-submit-reply" th:text="#{button.reply}">답글</button>
          </div>
        </form>
      </div>

      <!-- 프래그먼트 내부에서 자기 자신을 다시 호출 -->
      <div class="replies-container" th:if="${not #lists.isEmpty(reply.replies)}">
        <ul class="replies-list">
          <li th:replace="~{this :: renderReplies(${reply.replies}, ${post}, ${replyAddRequest})}"></li>
        </ul>
      </div>
    </div>
  </div>

</main>
<footer th:replace="~{/common/footer :: footer}"></footer>

<!-- JavaScript -->
<script src="/js/comments.js"></script>
<script th:inline="javascript">
  document.addEventListener('DOMContentLoaded', function() {
    const likeButton = document.getElementById('likeButton');
    const likeCount = document.getElementById('likeCount');
    const csrfToken = /*[[${_csrf.token}]]*/ '';
    const csrfHeader = /*[[${_csrf.headerName}]]*/ 'X-CSRF-TOKEN';
    const postId = /*[[${post.id}]]*/ '0';

    if (likeButton) {
      likeButton.addEventListener('click', async function() {
        try {
          const response = await fetch(`/posts/${postId}/like`, {
            method: 'POST',
            headers: {
              [csrfHeader]: csrfToken,
              'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
          });
          if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
          }
          const result = await response.json();
          if (result.success) {
            likeButton.classList.toggle('liked', result.isLiked);
            likeCount.textContent = result.likeCount;
            const icon = likeButton.querySelector('.like-icon');
            icon.style.animation = 'none';
            void icon.offsetWidth;
            icon.style.animation = 'heartBeat 0.6s';
          } else {
            alert(/*[[#{error.like.failed}]]*/ '좋아요 처리 중 오류가 발생했습니다.');
          }
        } catch (error) {
          console.error('Error:', error);
          alert(/*[[#{error.occurred}]]*/ '오류가 발생했습니다. 다시 시도해주세요.');
        }
      });
    }
  });
</script>
</body>
</html>
