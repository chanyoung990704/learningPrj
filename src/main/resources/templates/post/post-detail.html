<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{header :: head-common}"></head>
<body>
<!-- í—¤ë” í¬í•¨ -->
<div th:replace="~{header :: top-banner}"></div>

<main class="main-content post-detail-page">
  <!-- ê²Œì‹œê¸€ ì œëª© -->
  <h1 class="post-title" th:text="${post.title} ?: #{post.title.default}">Sample Title</h1>

  <!-- ê²Œì‹œê¸€ ì •ë³´ -->
  <div class="post-info">
    <span class="post-category" th:text="${post.category?.name} ?: #{post.category.unclassified}">Category</span>
    <span class="post-author" th:text="${post.author} ?: #{post.author.unknown}">Author Name</span>
    <span class="post-time" th:with="postTime=${post.time != null} ? ${#temporals.format(post.time, 'yyyy.MM.dd HH:mm')} : ''" 
          th:text="${postTime}">21:15</span>
  </div>

  <!-- ê²Œì‹œê¸€ ë‚´ìš© -->
  <div class="post-content" th:utext="${post.content}">
    <p>Sample content goes here...</p>
  </div>

  <!-- ì²¨ë¶€ ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ ì„¹ì…˜ -->
  <div class="post-attachments" th:if="${not #lists.isEmpty(post.imageAttachments) || not #lists.isEmpty(post.otherAttachments)}">
    <h3 th:text="#{post.attachments}">ì²¨ë¶€ íŒŒì¼</h3>

    <!-- ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ -->
    <div class="image-gallery" th:if="${not #lists.isEmpty(post.imageAttachments)}">
      <div th:each="image : ${post.imageAttachments}" class="gallery-item">
        <a th:href="@{/posts/uploads/images/{filename}(filename=${image.storedName})}" target="_blank">
          <img th:src="@{/posts/uploads/images/{filename}(filename=${image.storedName})}"
               th:alt="${image.originalName}" class="gallery-image">
        </a>
        <div class="image-caption" th:text="${image.originalName}">image.jpg</div>
      </div>
    </div>

    <!-- ì¼ë°˜ ì²¨ë¶€ íŒŒì¼ ëª©ë¡ -->
    <div class="file-attachments" th:if="${not #lists.isEmpty(post.otherAttachments)}">
      <h4 th:text="#{post.downloads}">ë‹¤ìš´ë¡œë“œ</h4>
      <ul class="attachment-list">
        <li th:each="file : ${post.otherAttachments}" class="attachment-item">
          <a th:href="@{/posts/uploads/files/{id}(id=${file.id})}" class="file-download-link">
            <span class="file-icon" th:text="#{file.icon}">ğŸ“</span>
            <span class="file-name" th:text="${file.originalName}">file.pdf</span>
            <span class="file-size" th:text="${#numbers.formatDecimal(file.fileSize / 1024, 0, 2)} + ' ' + #{post.file.size.kb}">123 KB</span>
          </a>
        </li>
      </ul>
    </div>
  </div>

  <!-- ê²Œì‹œê¸€ ì•¡ì…˜ ë²„íŠ¼ -->
  <div class="post-actions">
    <a th:href="@{/posts}" class="btn btn-secondary" th:text="#{button.back}">ëª©ë¡ìœ¼ë¡œ</a>
    <!-- ì‘ì„±ìë§Œ ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥ (ì˜µì…˜) -->
    <div th:if="${#authorization.expression('isAuthenticated()') && post.email == #authentication.name}" class="author-actions">
      <a th:href="@{/posts/{id}/edit(id=${post.id})}" class="btn btn-edit" th:text="#{button.edit}">ìˆ˜ì •</a>
      <form th:action="@{/posts/{id}(id=${post.id})}" method="post" style="display:inline;">
        <input type="hidden" name="_method" value="DELETE"/>
        <button type="submit" class="btn btn-delete" th:onclick="'return confirm(\'' + #{confirm.delete.post} + '\');'" th:text="#{button.delete}">ì‚­ì œ</button>
      </form>
    </div>
  </div>

  <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
  <div class="comments-section">
    <h2>
      <span th:text="#{comment.title}">Comments</span>
      <span class="comments-count" 
            th:text="${post.comments.totalElements}">
        0
      </span>
    </h2>

    <!-- ëŒ“ê¸€ì´ ì—†ëŠ” ê²½ìš° -->
    <div class="no-comments" th:if="${post.comments.empty}">
      <p th:text="#{comment.empty}">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
    </div>

    <!-- ëŒ“ê¸€ ëª©ë¡ -->
    <ul class="comments-list" th:if="${post.comments.hasContent()}">
      <li th:each="comment : ${post.comments.content}" class="comment-item" th:id="'comment-' + ${comment.id}">
        <div class="comment-header">
          <span class="comment-author" th:text="${comment.userName} ?: #{comment.author.unknown}">Commenter Name</span>
          <span class="comment-time" th:text="${#temporals.format(comment.createdAt, 'yyyy.MM.dd HH:mm')}">21:20</span>
          <!-- ëŒ“ê¸€ ì‘ì„±ìë§Œ ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥ -->
          <div class="comment-actions"
               th:if="${#authorization.expression('isAuthenticated()') and (comment.userEmail == #authentication.principal.email)}">
            <button class="btn-edit-comment" th:attr="data-comment-id=${comment.id}" th:text="#{button.edit}">ìˆ˜ì •</button>
            <form th:action="@{/posts/{postId}/comments/{commentId}(postId=${post.id},commentId=${comment.id})}"
                  method="post" style="display:inline;">
              <input type="hidden" name="_method" value="DELETE"/>
              <button type="submit" class="btn-delete-comment"
                      th:onclick="'return confirm(\'' + #{confirm.delete.comment} + '\');'" th:text="#{button.delete}">ì‚­ì œ</button>
            </form>
          </div>
        </div>
        <!-- ëŒ“ê¸€ ë‚´ìš© -->
        <div class="comment-content" th:id="'comment-content-' + ${comment.id}" th:text="${comment.content}">
          Sample comment content...
        </div>
        <!-- ëŒ“ê¸€ ìˆ˜ì • í¼(í¸ì§‘ ëª¨ë“œ) -->
        <div class="comment-edit-form" th:id="'comment-edit-form-' + ${comment.id}" style="display:none;">
          <form th:action="@{/posts/{postId}/comments/{commentId}(postId=${post.id},commentId=${comment.id})}"
                method="post" th:object="${commentEditRequest}">
            <input type="hidden" name="_method" value="PUT"/>
            <textarea name="content" class="edit-textarea"
                      th:text="${comment.content}"></textarea>
            <p class="error-message" th:if="${#fields.hasErrors('content')}" th:errors="*{content}"></p>
            <div class="edit-actions">
              <button type="button" class="btn-cancel-edit" th:attr="data-comment-id=${comment.id}" th:text="#{button.cancel}">ì·¨ì†Œ</button>
              <button type="submit" class="btn-save-edit" th:text="#{button.save}">ì €ì¥</button>
            </div>
          </form>
        </div>
      </li>
    </ul>

    <!-- í˜ì´ì§€ë„¤ì´ì…˜ UI -->
    <div class="comment-pagination" th:if="${post.comments.totalPages > 1}">
      <ul class="pagination">
        <li class="page-item" th:classappend="${post.comments.first} ? 'disabled'">
          <a class="page-link" th:href="@{/posts/{id}(id=${post.id},commentPage=${post.comments.number - 1})}"
             th:text="#{pagination.prev}" aria-label="Previous">ì´ì „</a>
        </li>
        <li class="page-item" th:each="pageNumber : ${#numbers.sequence(0, post.comments.totalPages - 1)}"
            th:classappend="${pageNumber == post.comments.number} ? 'active'">
          <a class="page-link" th:href="@{/posts/{id}(id=${post.id},commentPage=${pageNumber})}"
             th:text="${pageNumber + 1}">1</a>
        </li>
        <li class="page-item" th:classappend="${post.comments.last} ? 'disabled'">
          <a class="page-link" th:href="@{/posts/{id}(id=${post.id},commentPage=${post.comments.number + 1})}"
             th:text="#{pagination.next}" aria-label="Next">ë‹¤ìŒ</a>
        </li>
      </ul>
    </div>

    <!-- ëŒ“ê¸€ ì‘ì„± í¼ (ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ í‘œì‹œ) -->
    <div class="comment-form" th:if="${#authorization.expression('isAuthenticated()')}">
      <form th:action="@{/posts/{id}/comments(id=${post.id})}" method="post" th:object="${commentAddRequest}">
        <textarea name="content" th:placeholder="#{comment.placeholder}" th:attr="placeholder=#{comment.placeholder}" th:field="*{content}"></textarea>
        <p class="error-message" th:if="${#fields.hasErrors('content')}" th:errors="*{content}"></p>
        <button type="submit" class="btn comment-submit-btn" th:text="#{button.write}">ë“±ë¡</button>
      </form>
    </div>

    <!-- ë¡œê·¸ì¸ ì•ˆë‚´ ë©”ì‹œì§€ (ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ìì—ê²Œ í‘œì‹œ) -->
    <div class="login-prompt" th:if="${!#authorization.expression('isAuthenticated()')}">
      <p>
        <span th:text="#{comment.login.prefix}">ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ </span>
        <a th:href="@{/login}" th:text="#{button.login}">ë¡œê·¸ì¸</a>
        <span th:text="#{comment.login.suffix}">ì´ í•„ìš”í•©ë‹ˆë‹¤.</span>
      </p>
    </div>
  </div>

</main>

<!-- ì´ë¯¸ì§€ ë·°ì–´ ëª¨ë‹¬ -->
<div id="imageModal" class="image-modal">
  <span class="close-modal">&times;</span>
  <img class="modal-content" id="modalImage">
  <div id="imageCaption" class="modal-caption"></div>
</div>

<!-- í‘¸í„° í¬í•¨ -->
<div th:replace="~{footer :: footer}"></div>

<!-- ëŒ“ê¸€ ìˆ˜ì • ìŠ¤í¬ë¦½íŠ¸ -->
<script th:inline="javascript">
  document.addEventListener('DOMContentLoaded', function() {
    // ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ ì²˜ë¦¬
    document.querySelectorAll('.btn-edit-comment').forEach(button => {
      button.addEventListener('click', function() {
        const commentId = this.getAttribute('data-comment-id');
        const contentElement = document.getElementById('comment-content-' + commentId);
        const editFormElement = document.getElementById('comment-edit-form-' + commentId);
        const textarea = editFormElement.querySelector('textarea');

        // ê¸°ì¡´ ëŒ“ê¸€ ë‚´ìš©ì„ ìˆ˜ì • í¼ì˜ textareaì— ì„¤ì •
        textarea.value = contentElement.textContent.trim();

        // ëŒ“ê¸€ ë‚´ìš© ìˆ¨ê¸°ê³  ìˆ˜ì • í¼ í‘œì‹œ
        contentElement.style.display = 'none';
        editFormElement.style.display = 'block';
        // í…ìŠ¤íŠ¸ ì˜ì—­ì— í¬ì»¤ìŠ¤
        textarea.focus();
      });
    });

    // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ ì²˜ë¦¬
    document.querySelectorAll('.btn-cancel-edit').forEach(button => {
      button.addEventListener('click', function() {
        const commentId = this.getAttribute('data-comment-id');
        const contentElement = document.getElementById('comment-content-' + commentId);
        const editFormElement = document.getElementById('comment-edit-form-' + commentId);

        // ìˆ˜ì • í¼ ìˆ¨ê¸°ê³  ëŒ“ê¸€ ë‚´ìš© í‘œì‹œ
        editFormElement.style.display = 'none';
        contentElement.style.display = 'block';
      });
    });
  });
</script>

<!-- ì´ë¯¸ì§€ ë·°ì–´ ìŠ¤í¬ë¦½íŠ¸ -->
<script th:inline="javascript">
  document.addEventListener('DOMContentLoaded', function() {
    // ì´ë¯¸ì§€ ëª¨ë‹¬ ê´€ë ¨ ìš”ì†Œ
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    const captionText = document.getElementById('imageCaption');
    const closeBtn = document.getElementsByClassName('close-modal')[0];

    // ê°¤ëŸ¬ë¦¬ ì´ë¯¸ì§€ í´ë¦­ ì‹œ ëª¨ë‹¬ í‘œì‹œ
    const galleryImages = document.querySelectorAll('.gallery-image');
    galleryImages.forEach(img => {
      img.addEventListener('click', function(e) {
        e.preventDefault();
        modal.style.display = 'block';
        modalImg.src = this.src;
        captionText.innerHTML = this.alt;
      });
    });

    // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
    closeBtn.addEventListener('click', function() {
      modal.style.display = 'none';
    });

    // ëª¨ë‹¬ ì˜ì—­ ë°– í´ë¦­ ì‹œ ë‹«ê¸°
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });
  });
</script>

<!-- í…Œë§ˆ ìŠ¤í¬ë¦½íŠ¸ -->
<div th:replace="~{header :: theme-script}"></div>
</body>
</html>
