<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:fragment="head-common">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${title} ?: #{title.default}">My Awesome Site</title>

    <!-- CSRF í† í° ë©”íƒ€ íƒœê·¸ ì¶”ê°€ -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <!-- ê³µí†µ í°íŠ¸ ë° í•µì‹¬ ìŠ¤íƒ€ì¼ì‹œíŠ¸ -->
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/components/nav.css}">

    <!-- ë‹¤í¬ëª¨ë“œ ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ (FOUC ë°©ì§€) -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (prefersDark ? 'dark' : 'light');

            document.documentElement.setAttribute('data-bs-theme', theme);
        })();
    </script>

    <!-- ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ (í…Œë§ˆ ë³€ê²½ ë“±) -->
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            /* í…Œë§ˆ ë³€ê²½ ê¸°ëŠ¥ */
            const root = document.documentElement;
            const themeBtn = document.getElementById('theme-toggle-btn');

            if (themeBtn) {
                const setTheme = (mode) => {
                    console.log('Setting theme to:', mode);

                    if (mode === 'dark') {
                        root.setAttribute('data-bs-theme', 'dark');
                        themeBtn.textContent = 'â˜€ï¸';
                        themeBtn.setAttribute('title', '[[#{button.theme.light}]]');
                        localStorage.setItem('theme', 'dark');
                    } else {
                        root.setAttribute('data-bs-theme', 'light');
                        themeBtn.textContent = 'ğŸŒ™';
                        themeBtn.setAttribute('title', '[[#{button.theme.dark}]]');
                        localStorage.setItem('theme', 'light');
                    }
                };

                themeBtn.addEventListener('click', function(e) {
                    console.log('Theme button clicked');
                    e.preventDefault();

                    const currentTheme = root.getAttribute('data-bs-theme');
                    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                    setTheme(newTheme);
                });

                const savedTheme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                const currentTheme = savedTheme || (prefersDark ? 'dark' : 'light');
                setTheme(currentTheme);

                if (window.matchMedia) {
                    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
                        if (!localStorage.getItem('theme')) {
                            setTheme(e.matches ? 'dark' : 'light');
                        }
                    });
                }
            } else {
                console.warn('Theme toggle button not found');
            }

            /* ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥ ê°œì„  */
            const logoutForm = document.getElementById('logout-form');
            if (logoutForm) {
                logoutForm.addEventListener('submit', function(e) {
                    // ë¡œê·¸ì•„ì›ƒ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸
                    const confirmMessage = /*[[#{confirm.logout}]]*/ 'ì •ë§ ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
                    if (!confirm(confirmMessage)) {
                        e.preventDefault();
                        return false;
                    }

                    // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
                    const submitBtn = this.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.textContent = /*[[#{button.logout.processing}]]*/ 'ë¡œê·¸ì•„ì›ƒ ì¤‘...';
                    }

                    // ë¡œê·¸ì•„ì›ƒ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì •ë¦¬ (ì„ íƒì‚¬í•­)
                    try {
                        // í…Œë§ˆ ì„¤ì •ì€ ìœ ì§€í•˜ê³  ì‚¬ìš©ì ê´€ë ¨ ë°ì´í„°ë§Œ ì •ë¦¬
                        localStorage.removeItem('user-preferences');
                        sessionStorage.clear();
                    } catch (error) {
                        console.warn('Error clearing storage:', error);
                    }

                    // í¼ ì œì¶œì€ ê·¸ëŒ€ë¡œ ì§„í–‰ (Spring Securityê°€ ì²˜ë¦¬)
                    return true;
                });
            }
        });
    </script>
</head>

<body>

<div class="nav-container" th:fragment="top-banner">
    <nav class="nav-bar">
        <div class="nav-logo">
            <a th:href="@{/}" class="nav-link logo-text">
                <span class="nav-icon">ğŸŒŠ</span> <span class="nav-text" th:text="#{site.name}">MySite</span>
            </a>
        </div>
        <ul class="nav-menu">
            <!-- ì–¸ì–´ ì„ íƒê¸° -->
            <li class="language-selector">
                <button class="nav-link language-button" id="language-toggle">
                    <span class="language-flag">ğŸŒ</span>
                    <span class="language-text" th:text="#{language.current}">Language</span>
                </button>
                <ul class="language-dropdown">
                    <li><a href="?lang=ko" class="nav-link" th:classappend="${#locale.language == 'ko'} ? 'active' : ''"><span class="language-flag">ğŸ‡°ğŸ‡·</span> í•œêµ­ì–´</a></li>
                    <li><a href="?lang=en" class="nav-link" th:classappend="${#locale.language == 'en'} ? 'active' : ''"><span class="language-flag">ğŸ‡ºğŸ‡¸</span> English</a></li>
                </ul>
            </li>
            <!-- í…Œë§ˆ ë³€ê²½ ë²„íŠ¼ -->
            <li><button id="theme-toggle-btn" class="nav-link" type="button" th:title="#{button.theme.toggle.title}">ğŸŒ™</button></li>

            <!-- ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ê°œì„  -->
            <li th:if="!${#authorization.expression('isAuthenticated()')}">
                <a class="nav-link" th:href="@{/login}" th:text="#{button.login}">ë¡œê·¸ì¸</a>
            </li>
            <li th:if="${#authorization.expression('isAuthenticated()')}">
                <form id="logout-form" th:action="@{/logout}" method="post" style="display:inline;">
                    <!-- CSRF í† í° (Thymeleafê°€ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•˜ì§€ë§Œ ëª…ì‹œì ìœ¼ë¡œ ì¶”ê°€) -->
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <!-- ë¶ˆí•„ìš”í•œ logoutSuccessUrl ì œê±° (SecurityConfigì—ì„œ ì´ë¯¸ ì„¤ì •ë¨) -->
                    <button type="submit" class="nav-link logout-btn" th:text="#{button.logout}">ë¡œê·¸ì•„ì›ƒ</button>
                </form>
            </li>

            <!-- ê¸°íƒ€ ë©”ë‰´ -->
            <li><a class="nav-link" th:href="@{/register}" th:text="#{button.user.register}">íšŒì›ê°€ì…</a></li>
            <!-- ê²Œì‹œíŒ ë“œë¡­ë‹¤ìš´ ë©”ë‰´ -->
            <li class="nav-dropdown">
                <a class="nav-link" href="#" th:text="#{button.board}">ê²Œì‹œíŒ</a>
                <ul class="nav-dropdown-list">
                    <li th:each="category : ${allCategories}">
                        <a class="nav-link" th:href="@{/posts/{category}(category=${category.name})}" th:text="${category.name}"></a>
                    </li>
                </ul>
            </li>
        </ul>
    </nav>
</div>

</body>
</html>
